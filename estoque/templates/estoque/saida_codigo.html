{% extends "estoque/base.html" %}

{% block title %}Sa√≠da / Venda{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2>üßæ Sa√≠da / Venda</h2>

  <label>Buscar produto (Nome ou C√≥digo de Barras)</label>
  <input
    type="text"
    id="busca-produto"
    placeholder="Bipe o c√≥digo ou digite o nome..."
    autocomplete="off"
    style="margin-bottom: 5px;"
  >

  <ul id="resultado-busca" style="list-style:none; padding:0; margin-top:8px;"></ul>

  <hr style="margin:20px 0;">

  <div
    style="
      background:rgba(2,6,23,0.55);
      border:1px solid #1f2937;
      border-radius:12px;
      padding:14px;
      text-align:left;
      margin-bottom:16px;
    "
  >
    <div style="font-weight:800; margin-bottom:6px;">Pr√©via da venda</div>
    <div>Produto: <span id="prev-nome" style="font-weight:700;">‚Äî</span></div>
    <div>Pre√ßo unit√°rio: <span id="prev-unit" style="font-weight:700;">R$ 0,00</span></div>
    <div style="margin-top:8px; font-size:18px;">
      Total: <span id="prev-total" style="font-weight:900; color:#4ade80;">R$ 0,00</span>
    </div>
    <div id="prev-erro" style="margin-top:8px; color:#fecaca; font-weight:700;"></div>
  </div>

  <form method="post" id="form-venda">
    {% csrf_token %}

    <div style="display: none;">
        {{ form.codigo_barras }}
    </div>

    <label>Quantidade</label>
    {{ form.quantidade }}

    <button type="submit" style="margin-top: 15px;">
      ‚úÖ Confirmar Venda
    </button>
  </form>

</div>

<script>
const inputBusca = document.getElementById("busca-produto");
const lista = document.getElementById("resultado-busca");
const campoCodigoHidden = document.getElementById("id_codigo_barras");
const campoQtd = document.getElementById("id_quantidade");

// Elementos da Pr√©via
const prevNome = document.getElementById("prev-nome");
const prevUnit = document.getElementById("prev-unit");
const prevTotal = document.getElementById("prev-total");
const prevErro = document.getElementById("prev-erro");

let precoUnitarioAtual = 0;

function dinheiroBR(valor){
  const n = Number(valor) || 0;
  return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function limparPrevia(){
  prevNome.innerText = "‚Äî";
  prevUnit.innerText = "R$ 0,00";
  prevTotal.innerText = "R$ 0,00";
  prevErro.innerText = "";
  precoUnitarioAtual = 0;
  campoCodigoHidden.value = "";
}

function recalcularTotal() {
  const qtd = parseInt(campoQtd.value) || 0;
  const total = precoUnitarioAtual * qtd;
  prevTotal.innerText = "R$ " + dinheiroBR(total);
}

let timerBusca = null;
inputBusca.addEventListener("input", function(){
  const termo = inputBusca.value.trim();

  if(termo.length < 2){
    lista.innerHTML = "";
    if(termo.length === 0) limparPrevia();
    return;
  }

  clearTimeout(timerBusca);
  timerBusca = setTimeout(() => {
    fetch(`/consultar-estoque/?q=${encodeURIComponent(termo)}`)
      .then(res => res.json())
      .then(dados => {
        lista.innerHTML = "";
        
        // Se for um "bip" certeiro (c√≥digo de barras exato)
        if(dados.length === 1 && dados[0].codigo === termo) {
            selecionarProduto(dados[0]);
            return;
        }

        if(dados.length === 0){
          prevErro.innerText = "Produto n√£o encontrado.";
          return;
        }

        dados.forEach(p => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${p.nome}</strong><br><small>Qtd: ${p.estoque} | R$ ${p.preco_venda}</small>`;
          li.style = "padding:10px; border:1px solid #374151; border-radius:8px; margin-bottom:6px; cursor:pointer; background: #111827;";
          li.onclick = () => selecionarProduto(p);
          lista.appendChild(li);
        });
      });
  }, 300);
});

function selecionarProduto(p) {
    precoUnitarioAtual = parseFloat(String(p.preco_venda || p.preco).replace(",", ".")) || 0;
    prevNome.innerText = p.nome;
    prevUnit.innerText = "R$ " + dinheiroBR(precoUnitarioAtual);
    campoCodigoHidden.value = p.codigo;
    inputBusca.value = p.nome;
    lista.innerHTML = "";
    prevErro.innerText = "";
    
    recalcularTotal();
    
    // Foca na quantidade para o vendedor digitar
    campoQtd.focus();
    campoQtd.select();
}

campoQtd.addEventListener("input", recalcularTotal);
</script>
{% endblock %}
