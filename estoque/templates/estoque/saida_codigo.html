{% extends "estoque/base.html" %}

{% block title %}SaÃ­da / Venda{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2>ðŸ§¾ SaÃ­da / Venda</h2>

  <label>Buscar produto (Nome ou CÃ³digo de Barras)</label>
  <input
    type="text"
    id="busca-produto"
    placeholder="Bipe o cÃ³digo ou digite o nome..."
    autocomplete="off"
    style="margin-bottom: 5px;"
  >

  <ul id="resultado-busca" style="list-style:none; padding:0; margin-top:8px;"></ul>

  <hr style="margin:20px 0;">

  <div style="background:rgba(2,6,23,0.55); border:1px solid #1f2937; border-radius:12px; padding:14px; text-align:left; margin-bottom:16px;">
    <div style="font-weight:800; margin-bottom:6px;">PrÃ©via da venda</div>
    <div>Produto: <span id="prev-nome" style="font-weight:700;">â€”</span></div>
    <div>PreÃ§o unitÃ¡rio: <span id="prev-unit" style="font-weight:700;">R$ 0,00</span></div>
    <div style="margin-top:8px; font-size:18px;">
      Total: <span id="prev-total" style="font-weight:900; color:#4ade80;">R$ 0,00</span>
    </div>
    <div id="prev-erro" style="margin-top:8px; color:#fecaca; font-weight:700;"></div>
  </div>

  <form method="post" id="form-venda">
    {% csrf_token %}

    <input type="hidden" name="codigo_barras" id="id_codigo_barras">

    <label>Quantidade</label>
    <input 
        type="number" 
        name="quantidade" 
        id="id_quantidade" 
        class="form-control" 
        required 
        min="1" 
        placeholder="Digite a quantidade..."
        value="" 
        style="font-size: 20px; text-align: center;"
    >

    <button type="submit" id="btn-confirmar" style="margin-top: 15px; width: 100%; padding: 15px; font-weight: bold;">
      âœ… Confirmar Venda
    </button>
  </form>

</div>

<script>
const inputBusca = document.getElementById("busca-produto");
const lista = document.getElementById("resultado-busca");
const campoCodigoHidden = document.getElementById("id_codigo_barras");
const campoQtd = document.getElementById("id_quantidade");
const formVenda = document.getElementById("form-venda");

const prevNome = document.getElementById("prev-nome");
const prevUnit = document.getElementById("prev-unit");
const prevTotal = document.getElementById("prev-total");
const prevErro = document.getElementById("prev-erro");

let precoUnitarioAtual = 0;

function dinheiroBR(valor){
  const n = Number(valor) || 0;
  return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function recalcularTotal() {
  const qtd = parseInt(campoQtd.value) || 0;
  const total = precoUnitarioAtual * qtd;
  prevTotal.innerText = "R$ " + dinheiroBR(total);
}

// ðŸ›‘ TRAVA 1: Impede o Enter de enviar o formulÃ¡rio
formVenda.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // Bloqueia o envio automÃ¡tico
    return false;
  }
});

// ðŸ›‘ TRAVA 2: Impede o Enter no campo de busca (leitor)
inputBusca.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
  }
});

let timerBusca = null;
inputBusca.addEventListener("input", function(){
  const termo = inputBusca.value.trim();
  if(termo.length < 2) return;

  clearTimeout(timerBusca);
  timerBusca = setTimeout(() => {
    fetch(`/consultar-estoque/?q=${encodeURIComponent(termo)}`)
      .then(res => res.json())
      .then(dados => {
        lista.innerHTML = "";
        // Se o leitor achar o cÃ³digo exato
        if(dados.length === 1 && dados[0].codigo === termo) {
            selecionarProduto(dados[0]);
            inputBusca.value = ""; // Limpa a busca para o prÃ³ximo
            return;
        }
        // ... (resto da lÃ³gica de lista)
        dados.forEach(p => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${p.nome}</strong> - R$ ${p.preco_venda}`;
          li.style = "padding:10px; border:1px solid #374151; cursor:pointer; background: #111827; margin-bottom:5px; border-radius:8px;";
          li.onclick = () => selecionarProduto(p);
          lista.appendChild(li);
        });
      });
  }, 250);
});

function selecionarProduto(p) {
    precoUnitarioAtual = parseFloat(String(p.preco_venda).replace(",", ".")) || 0;
    prevNome.innerText = p.nome;
    prevUnit.innerText = "R$ " + dinheiroBR(precoUnitarioAtual);
    campoCodigoHidden.value = p.codigo;
    
    // âœ… LIMPEZA TOTAL: Garante que o campo nasÃ§a vazio e focado
    campoQtd.value = ""; 
    recalcularTotal();
    
    setTimeout(() => {
        campoQtd.focus();
    }, 200);
}

campoQtd.addEventListener("input", recalcularTotal);
</script>
{% endblock %}