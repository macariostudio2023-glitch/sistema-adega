{% extends "estoque/base.html" %}

{% block title %}SaÃ­da / Venda{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2 style="text-align:center;">ðŸ§¾ SaÃ­da / Venda</h2>

  {% if messages %}
    <ul style="list-style:none; padding:0; margin:12px 0;">
      {% for message in messages %}
        <li style="margin-bottom:8px; padding:10px; border-radius:10px; font-weight:bold; text-align:center; background:{% if message.tags == 'error' %}rgba(239,68,68,.25){% else %}rgba(34,197,94,.25){% endif %}; color: white;">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <label>Buscar produto (Nome ou CÃ³digo de Barras)</label>
  <input
    type="text"
    id="busca-produto"
    placeholder="Bipe o cÃ³digo ou digite o nome..."
    autocomplete="off"
    style="margin-bottom: 5px; width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white;"
    autofocus
  >

  <ul id="resultado-busca" style="list-style:none; padding:0; margin-top:8px;"></ul>

  <hr style="margin:20px 0; border-color: #374151;">

  <div style="background:rgba(2,6,23,0.55); border:1px solid #1f2937; border-radius:12px; padding:14px; text-align:left; margin-bottom:16px;">
    <div style="font-weight:800; margin-bottom:6px; color: #9ca3af;">PRÃ‰VIA DA VENDA</div>
    <div style="font-size: 1.1em;">Produto: <span id="prev-nome" style="font-weight:700; color: #60a5fa;">â€”</span></div>
    <div>PreÃ§o unitÃ¡rio: <span id="prev-unit" style="font-weight:700;">R$ 0,00</span></div>
    <div style="margin-top:8px; font-size:22px;">
      Total: <span id="prev-total" style="font-weight:900; color:#4ade80;">R$ 0,00</span>
    </div>
    <div id="prev-erro" style="margin-top:8px; color:#fecaca; font-weight:700;"></div>
  </div>

  <form method="post" id="form-venda">
    {% csrf_token %}
    <input type="hidden" name="codigo_barras" id="id_codigo_barras">
    <input type="hidden" name="acao" value="salvar"> <label>Quantidade</label>
    <input 
        type="number" 
        name="quantidade" 
        id="id_quantidade" 
        class="form-control" 
        required 
        min="1" 
        placeholder="0"
        style="width: 100%; font-size: 28px; text-align: center; font-weight: bold; background: #0f172a; color: #4ade80; border: 2px solid #1e293b; border-radius: 12px; padding: 10px;"
    >

    <button type="button" id="btn-confirmar-venda" style="margin-top: 15px; width: 100%; padding: 18px; font-size: 1.2em; font-weight: bold; background-color: #22c55e; color: white; border: none; border-radius: 12px; cursor: pointer; transition: 0.3s;">
      âœ… Confirmar Venda
    </button>
    
    <a href="{% url 'saida_codigo' %}" style="display:block; text-align:center; margin-top:15px; color:#9ca3af; text-decoration:none;">Limpar Tela</a>
  </form>

</div>

<script>
const inputBusca = document.getElementById("busca-produto");
const lista = document.getElementById("resultado-busca");
const campoCodigoHidden = document.getElementById("id_codigo_barras");
const campoQtd = document.getElementById("id_quantidade");
const formVenda = document.getElementById("form-venda");
const btnConfirmar = document.getElementById("btn-confirmar-venda");

const prevNome = document.getElementById("prev-nome");
const prevUnit = document.getElementById("prev-unit");
const prevTotal = document.getElementById("prev-total");

let precoUnitarioAtual = 0;

function dinheiroBR(valor){
  const n = Number(valor) || 0;
  return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function recalcularTotal() {
  const qtd = parseInt(campoQtd.value) || 0;
  const total = precoUnitarioAtual * qtd;
  prevTotal.innerText = "R$ " + dinheiroBR(total);
}

// ðŸ›‘ TRAVA GLOBAL: Impede o Enter de submeter o formulÃ¡rio sozinho
window.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    // Se estiver na quantidade, o Enter confirma a venda
    if (document.activeElement === campoQtd) {
        confirmarVenda();
    } else {
        e.preventDefault();
    }
  }
}, true);

function confirmarVenda() {
    const qtd = parseInt(campoQtd.value) || 0;
    if (qtd <= 0 || !campoCodigoHidden.value) {