{% extends "estoque/base.html" %}

{% block title %}Sa√≠da / Venda{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2>üßæ Sa√≠da / Venda</h2>

  <label>Buscar produto pelo nome</label>
  <input
    type="text"
    id="busca-produto"
    placeholder="Digite o nome do produto"
    autocomplete="off"
  >

  <ul id="resultado-busca" style="list-style:none; padding:0; margin-top:8px;"></ul>

  <hr style="margin:20px 0;">

  <div
    style="
      background:rgba(2,6,23,0.55);
      border:1px solid #1f2937;
      border-radius:12px;
      padding:14px;
      text-align:left;
      margin-bottom:16px;
    "
  >
    <div style="font-weight:800; margin-bottom:6px;">Pr√©via da venda</div>
    <div>Produto: <span id="prev-nome" style="font-weight:700;">‚Äî</span></div>
    <div>Pre√ßo unit√°rio: <span id="prev-unit" style="font-weight:700;">R$ 0,00</span></div>
    <div style="margin-top:8px; font-size:18px;">
      Total: <span id="prev-total" style="font-weight:900; color:#4ade80;">R$ 0,00</span>
    </div>
    <div id="prev-erro" style="margin-top:8px; color:#fecaca; font-weight:700;"></div>
  </div>

  <form method="post">
    {% csrf_token %}

    <label>C√≥digo de barras</label>
    {{ form.codigo_barras }}

    <label>Quantidade</label>
    {{ form.quantidade }}

    <button type="submit" style="margin-top: 15px;">
      ‚úÖ Confirmar Venda
    </button>
  </form>

</div>

<script>
const inputBusca = document.getElementById("busca-produto");
const lista = document.getElementById("resultado-busca");
const campoCodigo = document.getElementById("id_codigo_barras");
const campoQtd = document.getElementById("id_quantidade");

// ‚úÖ Elementos da Pr√©via
const prevNome = document.getElementById("prev-nome");
const prevUnit = document.getElementById("prev-unit");
const prevTotal = document.getElementById("prev-total");
const prevErro = document.getElementById("prev-erro");

let precoUnitarioAtual = 0; // Armazena o pre√ßo para c√°lculo r√°pido

function dinheiroBR(valor){
  const n = Number(valor) || 0;
  return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function limparPrevia(){
  prevNome.innerText = "‚Äî";
  prevUnit.innerText = "R$ 0,00";
  prevTotal.innerText = "R$ 0,00";
  prevErro.innerText = "";
  precoUnitarioAtual = 0;
}

// Faz o c√°lculo matem√°tico sem precisar ir no servidor de novo
function recalcularTotal() {
  const qtd = parseInt(campoQtd.value) || 0;
  const total = precoUnitarioAtual * qtd;
  prevTotal.innerText = "R$ " + dinheiroBR(total);
  
  if (qtd <= 0 && campoCodigo.value !== "") {
    prevErro.innerText = "Insira a quantidade.";
  } else {
    prevErro.innerText = "";
  }
}

let timerPrevia = null;
function atualizarPrevia(){
  const codigo = (campoCodigo.value || "").trim();
  const qtd = parseInt(campoQtd.value) || 0;

  if(!codigo){
    limparPrevia();
    return;
  }

  clearTimeout(timerPrevia);
  timerPrevia = setTimeout(() => {
    fetch(`/consultar-estoque/?q=${encodeURIComponent(codigo)}`)
      .then(res => res.json())
      .then(dados => {
        if(!dados || dados.length === 0){
          prevErro.innerText = "Produto n√£o encontrado.";
          limparPrevia();
          return;
        }

        const p = dados[0];
        // Busca a chave 'preco_venda' que adicionamos no Python
        precoUnitarioAtual = parseFloat(String(p.preco_venda || p.preco).replace(",", ".")) || 0;
        
        prevNome.innerText = p.nome || "‚Äî";
        prevUnit.innerText = "R$ " + dinheiroBR(precoUnitarioAtual);
        
        recalcularTotal(); // Calcula o total inicial
      })
      .catch(() => {
        prevErro.innerText = "Erro ao consultar o produto.";
      });
  }, 200);
}

// Eventos para atualizar a tela
campoCodigo.addEventListener("input", atualizarPrevia);

// Quando mudar a quantidade, apenas recalcula o total (mais r√°pido)
campoQtd.addEventListener("input", recalcularTotal);
campoQtd.addEventListener("change", recalcularTotal);

// üîç Busca por nome
inputBusca.addEventListener("keyup", function(){
  const termo = inputBusca.value.trim();
  if(termo.length < 2){
    lista.innerHTML = "";
    return;
  }

  fetch(`/consultar-estoque/?q=${encodeURIComponent(termo)}`)
    .then(res => res.json())
    .then(dados => {
      lista.innerHTML = "";
      if(dados.length === 0) return;

      dados.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${p.nome}</strong>
          <br>
          <small>Estoque: ${p.estoque} | R$ ${p.preco_venda || p.preco}</small>
        `;
        li.style = "padding:10px; border:1px solid #374151; border-radius:8px; margin-bottom:6px; cursor:pointer; background: #111827;";

        li.onclick = () => {
          campoCodigo.value = p.codigo;
          lista.innerHTML = "";
          inputBusca.value = p.nome;
          
          // Foca na quantidade e seleciona o texto para o vendedor s√≥ digitar o n√∫mero
          atualizarPrevia();
          campoQtd.focus();
          campoQtd.select(); 
        };
        lista.appendChild(li);
      });
    });
});

// Inicializa√ß√£o
window.onload = atualizarPrevia;
</script>
{% endblock %}