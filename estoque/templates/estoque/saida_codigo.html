{% extends "estoque/base.html" %}

{% block title %}Sa√≠da / Venda{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2>üßæ Sa√≠da / Venda</h2>

  <label>Buscar produto (Nome ou C√≥digo de Barras)</label>
  <input
    type="text"
    id="busca-produto"
    placeholder="Bipe o c√≥digo ou digite o nome..."
    autocomplete="off"
    style="margin-bottom: 5px;"
  >

  <ul id="resultado-busca" style="list-style:none; padding:0; margin-top:8px;"></ul>

  <hr style="margin:20px 0;">

  <div style="background:rgba(2,6,23,0.55); border:1px solid #1f2937; border-radius:12px; padding:14px; text-align:left; margin-bottom:16px;">
    <div style="font-weight:800; margin-bottom:6px;">Pr√©via da venda</div>
    <div>Produto: <span id="prev-nome" style="font-weight:700;">‚Äî</span></div>
    <div>Pre√ßo unit√°rio: <span id="prev-unit" style="font-weight:700;">R$ 0,00</span></div>
    <div style="margin-top:8px; font-size:18px;">
      Total: <span id="prev-total" style="font-weight:900; color:#4ade80;">R$ 0,00</span>
    </div>
    <div id="prev-erro" style="margin-top:8px; color:#fecaca; font-weight:700;"></div>
  </div>

  <form method="post" id="form-venda">
    {% csrf_token %}

    <input type="hidden" name="codigo_barras" id="id_codigo_barras">

    <label>Quantidade</label>
    <input 
        type="number" 
        name="quantidade" 
        id="id_quantidade" 
        class="form-control" 
        required 
        min="1" 
        placeholder="0"
        value="" 
        style="font-size: 24px; text-align: center; font-weight: bold; background: #0f172a; color: white; border: 1px solid #334155;"
    >

    <button type="button" id="btn-finalizar" style="margin-top: 15px; width: 100%; padding: 15px; font-weight: 800; background-color: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">
      ‚úÖ CONFIRMAR VENDA
    </button>
  </form>

</div>

<script>
const inputBusca = document.getElementById("busca-produto");
const lista = document.getElementById("resultado-busca");
const campoCodigoHidden = document.getElementById("id_codigo_barras");
const campoQtd = document.getElementById("id_quantidade");
const formVenda = document.getElementById("form-venda");
const btnFinalizar = document.getElementById("btn-finalizar");

const prevNome = document.getElementById("prev-nome");
const prevUnit = document.getElementById("prev-unit");
const prevTotal = document.getElementById("prev-total");
const prevErro = document.getElementById("prev-erro");

let precoUnitarioAtual = 0;

function dinheiroBR(valor){
  const n = Number(valor) || 0;
  return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function recalcularTotal() {
  const qtd = parseInt(campoQtd.value) || 0;
  const total = precoUnitarioAtual * qtd;
  prevTotal.innerText = "R$ " + dinheiroBR(total);
}

// üõë TRAVA TOTAL: Impede que o formul√°rio seja enviado por qualquer tecla (Enter do leitor)
formVenda.onsubmit = (e) => { e.preventDefault(); return false; };

// ‚úÖ ENVIO MANUAL: S√≥ envia quando voc√™ clicar no bot√£o verde
btnFinalizar.addEventListener("click", function() {
  const qtd = parseInt(campoQtd.value) || 0;
  const codigo = campoCodigoHidden.value;

  if (!codigo) {
    alert("Macario, bipe ou selecione um produto primeiro!");
    inputBusca.focus();
    return;
  }

  if (qtd <= 0) {
    alert("Macario, a quantidade deve ser pelo menos 1!");
    campoQtd.focus();
    return;
  }

  // Se tudo estiver certo, envia o formul√°rio
  formVenda.submit();
});

let timerBusca = null;
inputBusca.addEventListener("input", function(){
  const termo = inputBusca.value.trim();
  if(termo.length < 2) return;

  clearTimeout(timerBusca);
  timerBusca = setTimeout(() => {
    fetch(`/consultar-estoque/?q=${encodeURIComponent(termo)}`)
      .then(res => res.json())
      .then(dados => {
        lista.innerHTML = "";
        
        // Se for um BIP certeiro
        if(dados.length === 1 && (dados[0].codigo === termo)) {
            selecionarProduto(dados[0]);
            inputBusca.value = ""; 
            return;
        }

        if(dados.length === 0){
          prevErro.innerText = "Produto n√£o encontrado.";
          return;
        }

        dados.forEach(p => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${p.nome}</strong><br><small>R$ ${p.preco_venda}</small>`;
          li.style = "padding:10px; border:1px solid #374151; border-radius:8px; margin-bottom:6px; cursor:pointer; background: #111827;";
          li.onclick = () => {
              selecionarProduto(p);
              inputBusca.value = p.nome;
              lista.innerHTML = "";
          };
          lista.appendChild(li);
        });
      });
  }, 250);
});

function selecionarProduto(p) {
    precoUnitarioAtual = parseFloat(String(p.preco_venda || p.preco).replace(",", ".")) || 0;
    prevNome.innerText = p.nome;
    prevUnit.innerText = "R$ " + dinheiroBR(precoUnitarioAtual);
    campoCodigoHidden.value = p.codigo;
    
    // ‚úÖ Limpa o campo e foca
    campoQtd.value = ""; 
    recalcularTotal();
    
    setTimeout(() => {
        campoQtd.focus();
    }, 200);
}

campoQtd.addEventListener("input", recalcularTotal);

// Bloqueia o Enter no campo de busca para o leitor n√£o dar "submit"
inputBusca.addEventListener("keydown", function(e) {
    if (e.key === "Enter") e.preventDefault();
});
</script>
{% endblock %}