{% extends "estoque/base.html" %}

{% block title %}Entrada - Sistema Adega{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card">

  <h2 style="text-align:center;">ðŸ“¦ Entrada por CÃ³digo de Barras</h2>
  <p style="text-align:center; margin-top:6px; font-size: 0.9em; opacity: 0.8;">
    APONTE O LEITOR E CONFIRME A ENTRADA
  </p>

  {% if messages %}
    <ul style="list-style:none; padding:0; margin:12px 0;">
      {% for message in messages %}
        <li style="margin-bottom:8px; padding:10px; border-radius:10px; font-weight:bold; text-align:center; background:{% if message.tags == 'error' %}rgba(239,68,68,.25){% else %}rgba(34,197,94,.25){% endif %};">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" id="entradaForm">
    {% csrf_token %}

    <label style="text-align:left;">CÃ³digo de barras</label>
    <div style="display: flex; gap: 5px;">
        <input type="text" name="codigo_barras" id="id_codigo_barras" 
               inputmode="none" required autofocus 
               style="flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white;">
        
        <button type="button" id="btn-consulta" style="width: 50px; background: #4b5563; padding: 0;">ðŸ”Ž</button>
    </div>

    <label style="text-align:left; margin-top: 15px; display: block;">Quantidade</label>
    {{ form.quantidade }}

    <button type="submit" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.1em; background: #2563eb;">
        Confirmar Entrada
    </button>

    <div class="hint" style="text-align:center; margin-top: 15px;">
      Bipou â†’ ENTER confirma | Toque na ðŸ”Ž para buscar
    </div>
  </form>

  <hr style="margin:26px 0; border-color:#1f2937; opacity:.6;">

  <h3 id="titulo-consulta" style="text-align:center; margin:0 0 10px 0;">
    ðŸ”Ž Consultar no estoque
  </h3>

  <input
    type="text"
    id="busca-produto"
    placeholder="Digite nome ou cÃ³digo..."
    style="margin-bottom:10px; text-align:center; width: 100%; padding: 12px;"
  >

  <div id="resultado-estoque"></div>

</div>

<script>
  const campoCodigo = document.getElementById("id_codigo_barras");
  const campoBusca = document.getElementById("busca-produto");
  const form = document.getElementById("entradaForm");
  const resultado = document.getElementById("resultado-estoque");
  const btnConsulta = document.getElementById("btn-consulta");

  // âœ… FOCO AUTOMÃTICO E TRAVA TECLADO
  window.onload = function () {
    if (campoCodigo) {
        campoCodigo.focus();
        campoCodigo.inputMode = "none"; // Garante que o Android nÃ£o abra o teclado
    }
  };

  // âœ… CLICK NA LUPA (Substitui F2 no Tablet)
  btnConsulta.addEventListener("click", function() {
      campoBusca.focus();
      campoBusca.scrollIntoView({behavior: "smooth"});
  });

  // âœ… ENTER DO LEITOR
  if (campoCodigo) {
    campoCodigo.addEventListener("keydown", function(e){
      if (e.key === "Enter") {
        // Se o cÃ³digo estiver vazio, nÃ£o deixa enviar
        if(this.value.trim() === "") {
            e.preventDefault();
            return;
        }
        // Se quiser que o leitor envie o form direto:
        form.submit();
      }
    });
  }

  // âœ… F2 CONTINUA FUNCIONANDO (Caso usem teclado fÃ­sico)
  document.addEventListener("keydown", function(e){
    if (e.key === "F2") {
      e.preventDefault();
      campoBusca.focus();
      campoBusca.select();
    }
  });

  // âœ… BUSCA AJAX (Debounce)
  let timer = null;
  campoBusca.addEventListener("input", function () {
    const termo = this.value.trim();
    clearTimeout(timer);
    timer = setTimeout(() => buscarEstoque(termo), 250);
  });

  function buscarEstoque(termo){
    if (termo.length < 2) {
      resultado.innerHTML = "";
      return;
    }

    fetch(`/consultar-estoque/?q=${encodeURIComponent(termo)}`)
      .then(res => res.json())
      .then(dados => {
        if (!dados || dados.length === 0) {
          resultado.innerHTML = `<div style="padding:12px; border-radius:12px; text-align:center; background:rgba(239,68,68,.15);">NÃ£o encontrado.</div>`;
          return;
        }

        let html = "<ul style='list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;'>";
        dados.forEach(p => {
          const estoqueBaixo = Number(p.estoque) <= 5;
          html += `
            <li onclick="selecionarProduto('${p.codigo}')" style="cursor:pointer; padding:12px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); text-align:center;">
              <div style="font-weight:bold;">${p.nome}</div>
              <div style="font-size:0.9em; opacity:.8;">Cod: ${p.codigo || "-"} | R$ ${p.preco}</div>
              <div style="font-weight:bold; color:${estoqueBaixo ? '#f87171' : '#a7f3d0'};">Estoque: ${p.estoque}</div>
            </li>`;
        });
        html += "</ul>";
        resultado.innerHTML = html;
      });
  }

  function selecionarProduto(codigo){
    if(!codigo || !campoCodigo) return;
    campoCodigo.value = codigo;
    campoCodigo.focus();
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
</script>
{% endblock %}