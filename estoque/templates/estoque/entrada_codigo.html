{% extends "estoque/base.html" %}

{% block title %}Entrada - Sistema Adega{% endblock %}
{% block page_wrapper_class %}center-screen{% endblock %}

{% block content %}
<div class="centered-card" style="max-width: 500px; margin: 0 auto;">

  {% if promos %}
  <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; padding: 15px; margin-bottom: 25px; border-radius: 12px;">
      <h3 style="color: #f59e0b; margin: 0 0 10px 0; font-size: 1em; display: flex; align-items: center; gap: 8px;">
        <span>ðŸ”¥</span> Radar de Oportunidades (Atacado)
      </h3>
      <ul style="list-style: none; padding: 0; margin: 0;">
          {% for promo in promos %}
          <li style="margin-bottom: 10px; border-bottom: 1px solid rgba(245, 158, 11, 0.2); padding-bottom: 8px;">
              <a href="{{ promo.link }}" target="_blank" style="color: #e2e8f0; text-decoration: none; font-size: 0.85em; line-height: 1.4; display: block;">
                  {{ promo.titulo }} <span style="color: #3b82f6; font-weight: bold;">[ler]</span>
              </a>
          </li>
          {% endfor %}
      </ul>
      <p style="margin: 5px 0 0 0; font-size: 0.7em; opacity: 0.6; text-align: right;">Atualizado agora</p>
  </div>
  {% endif %}

  <h2 style="text-align:center;">ðŸ“¦ Entrada de Estoque</h2>
  <p style="text-align:center; margin-top:6px; font-size: 0.9em; opacity: 0.8;">
    {% if produto %} CONFIRME OS DADOS ABAIXO {% else %} APONTE O LEITOR PARA LOCALIZAR {% endif %}
  </p>

  {% if messages %}
    <ul style="list-style:none; padding:0; margin:12px 0;">
      {% for message in messages %}
        <li style="margin-bottom:8px; padding:10px; border-radius:10px; font-weight:bold; text-align:center; background:{% if message.tags == 'error' %}rgba(239,68,68,.25){% else %}rgba(34,197,94,.25){% endif %};">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" id="entradaForm">
    {% csrf_token %}

    <label style="display:block; text-align:left; margin-bottom: 5px;">CÃ³digo de barras</label>
    <div style="display: flex; gap: 5px;">
        <input type="text" name="codigo_barras" id="id_codigo_barras" 
               required autofocus 
               value="{{ codigo|default:'' }}"
               style="flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white;">
        
        <button type="submit" name="acao" value="buscar" style="width: 50px; background: #4b5563; border: none; border-radius: 8px; color: white; cursor: pointer;">ðŸ”Ž</button>
    </div>

    {% if produto %}
    <div style="margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(37, 99, 235, 0.1); border: 1px solid #2563eb;">
        <h3 style="margin: 0; color: #60a5fa;">{{ produto.nome }}</h3>
        <p style="margin: 5px 0; opacity: 0.8;">Estoque atual: <strong>{{ produto.estoque_atual }}</strong></p>
        
        <label style="text-align:left; margin-top: 10px; display: block;">Quantidade a adicionar</label>
        <input type="number" name="quantidade" id="id_quantidade" value="1" min="1"
               style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white;">

        <button type="submit" name="acao" value="salvar" 
                style="margin-top: 15px; width: 100%; padding: 15px; font-size: 1.1em; background: #22c55e; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
            âœ… CONFIRMAR ENTRADA
        </button>
        
        <a href="{% url 'entrada_codigo' %}" style="display:block; text-align:center; margin-top:10px; color:#9ca3af; text-decoration:none; font-size:0.9em;">Cancelar</a>
    </div>
    {% else %}
    <button type="submit" name="acao" value="buscar" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.1em; background: #2563eb; border: none; border-radius: 8px; color: white; cursor: pointer;">
        BUSCAR PRODUTO
    </button>
    {% endif %}

    <div class="hint" style="text-align:center; margin-top: 15px; font-size: 0.8em; opacity: 0.6;">
      Bipou â†’ Localiza | Confirmar â†’ Entra no estoque
    </div>
  </form>

  <hr style="margin:26px 0; border-color:#1f2937; opacity:.6;">

  <h3 style="text-align:center; margin:0 0 10px 0;">ðŸ”Ž Consultar no estoque</h3>
  <input type="text" id="busca-produto" placeholder="Digite nome ou cÃ³digo..."
    style="margin-bottom:10px; text-align:center; width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white;">

  <div id="resultado-estoque"></div>
</div>

<script>
  window.onload = function () {
    const campoCodigo = document.getElementById("id_codigo_barras");
    const campoQuantidade = document.getElementById("id_quantidade");
    if (campoQuantidade) {
        campoQuantidade.focus();
        campoQuantidade.select();
    } else if (campoCodigo) {
        campoCodigo.focus();
    }
  };

  const campoBusca = document.getElementById("busca-produto");
  if (campoBusca) {
    campoBusca.addEventListener("input", function() {
      const q = this.value;
      if (q.length > 2) {
        fetch(`/consultar-estoque/?q=${q}`)
          .then(r => r.json())
          .then(data => {
            let html = "";
            data.forEach(p => {
              html += `<div style="padding:8px; border-bottom:1px solid #374151;">${p.nome} - Qtd: ${p.estoque}</div>`;
            });
            document.getElementById("resultado-estoque").innerHTML = html;
          });
      }
    });
  }
</script>
{% endblock %}